version: "3"
services:
    pypi:
        image: pef/pypi
        volumes:
            - ~/pypi:/srv/pypi:rw
        ports:
            - 8080:80

    db:
        image: pef/mariadb5
        environment:
            - MYSQL_ROOT_PASSWORD=password
            - MYSQL_DATABASE=employee
            - MYSQL_USER=employee
            - MYSQL_PASSWORD=password
        ports:
            - "13306:3306"

    behave:
        image: pef/python3
        depends_on:
            - db
        command: "behave src/test/python/features"
        volumes:
            - .:/code
        environment:
            - PYTHONPATH=/code/src/main/python:/code/src/test/python
            - PIP_EXTRA_INDEX_URL=http://pypi:80/simple/

    pytest:
        image: pef/python3
        depends_on:
            - db
        command: "pytest -v"
        volumes:
            - .:/code
        environment:
            - PYTHONPATH=/code/src/main/python:/code/src/test/python
            - PIP_EXTRA_INDEX_URL=http://pypi:80/simple/

    main:
        image: pef/python3
        depends_on:
            - pypi
        command: "/code/upload_internal.sh"
        volumes:
            - ./src/main/python:/code

    test:
        image: pef/python3
        depends_on:
            - pypi
            - db
        command: "/code/src/test/python/test.sh"
        volumes:
            - .:/code
#            - ./src/test/python:/code
#            - ./src/test/env:/code/env
        environment:
            - PIP_EXTRA_INDEX_URL=http://pypi:80/simple/
